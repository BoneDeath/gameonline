<script src="/socket.io/socket.io.js"></script>
<style>
  body {
    padding: 0;
    margin: 0;
    overflow: hidden;
  }
  canvas {
    display: block;
  }
</style>
<canvas id="canvas"></canvas>

<script>
  const socket = io();
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let isMouseDown = false;
  const myColor = getRandomHexColor();
  let lastUpdateTime = 0;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  canvas.addEventListener("mousedown", () => (isMouseDown = true));
  canvas.addEventListener("mouseup", () => (isMouseDown = false));
  canvas.addEventListener("mousemove", drawImage);

  socket.on("server", (msg) => {
    console.log(msg);
  });

  socket.on("draw", (data) => {
    ctx.fillStyle = data.color;
    ctx.fillRect(data.x, data.y, 5, 5);
  });

  function drawImage(e) {
    if (!isMouseDown) return;
    const x = e.clientX;
    const y = e.clientY;
    socket.emit("draw", { x, y, color: myColor });
  }

  function getRandomHexColor() {
    const randomColor = Math.floor(Math.random() * 16777215).toString(16);
    return `#${randomColor.padStart(6, "0")}`;
  }

  function draw_ping(delay) {
    setTimeout(() => {
      const startTime = Date.now();
      socket.emit("ping");

      socket.once("pong", () => {
        const latency = Date.now() - startTime;
        ctx.clearRect(10, 20, 150, 40);
        ctx.font = "22px Georgia";
        ctx.fillStyle = "black";
        ctx.fillText(`Ping: ${latency}ms`, 11, 50);
      });
    }, delay);
  }

  function drawVector(delay) {
    setTimeout(() => {}, delay);
  }

  function update() {
    drawVector(1000);
    draw_ping(1000);
    requestAnimationFrame(update);
  }

  requestAnimationFrame(update);
</script>
