<script src="/socket.io/socket.io.js"></script>
<style>
  body {
    padding: 0;
    margin: 0;
    overflow: hidden;
  }
  canvas {
    display: block;
  }
</style>
<canvas id="canvas"></canvas>

<script>
  const socket = io();
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let latency = NaN;
  let startTime;
  let my_id = Date.now();

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  mouse = {
    x: 0,
    y: 0,
    width: 0,
    height: 0,
    isClicked:false,
  };

  world = { width: 2000, height: 2000 };
  map = [
    [
      0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0,
      0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0,
    ],
    [
      0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0,
      0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0,
    ],
    [
      0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0,
      0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0,
    ],
    [
      0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0,
    ],
    [
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1,
      0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0,
    ],
    [
      0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1,
      0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0,
    ],
    [
      0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0,
      0, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 1,
    ],
    [
      0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 1,
      0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0,
    ],
    [
      1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1,
      0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0,
    ],
    [
      0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1,
      0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0,
    ],
    [
      0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0,
      1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 1, 0,
    ],
    [
      1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0,
      1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1,
    ],
    [
      1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 0, 0,
      1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0,
    ],
    [
      0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0,
      0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0,
      0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1,
    ],
    [
      0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1,
      1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0,
    ],
    [
      0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0,
      1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0,
    ],
    [
      1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0,
      0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0,
    ],
    [
      0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1,
      1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1,
    ],
    [
      0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1,
      1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 0,
    ],
    [
      1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1,
      1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0,
    ],
    [
      0, 1, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0,
      1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1,
    ],
    [
      1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1,
      0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1,
    ],
  ];

  // Cache untuk menyimpan warna berdasarkan nilai tile bisa dirubah dengan texture/spritemaps
  const tileColorCache = {
    0: "#ffffff", // Warna untuk tile dengan nilai 0
    1: "#444444", // Warna untuk tile dengan nilai 1
    default: "#333333", // Warna default
  };

  canvas.addEventListener("mousedown", (event) => (updateMouseEvent(event,true)));
  canvas.addEventListener("mousemove", (event) => ((mouse.isMouseClick)?updateMouseEvent(event,true):''));
  canvas.addEventListener("mouseup", (event) => (updateMouseEvent(event,false)));

  function updateMouseEvent(e,isMouseClick) {
    mouse.isMouseClick=isMouseClick;
    mouse.x = e.clientX;
    mouse.y = e.clientY;
  }

  tileSize = {
    width: world.width / map[0].length,
    height: world.height / map.length,
  };

  players = [];
  camera = { x: 0, y: 0, width: canvas.width, height: canvas.height };

  socket.emit("join", my_id);

  //movement control
  document.onkeydown = function (e) {
    switch (e.keyCode) {
      case 37:
      case 97:
        socket.emit("move", { id: my_id, move: "left" });
        break;
      case 38:
      case 119:
        socket.emit("move", { id: my_id, move: "up" });
        break;
      case 39:
      case 100:
        socket.emit("move", { id: my_id, move: "right" });
        break;
      case 40:
      case 115:
        socket.emit("move", { id: my_id, move: "down" });
        break;
    }
  };

  function updateCamera() {
    const me = players.find((player) => player.id == my_id);
    camera.x = Math.max(
      0,
      Math.min(world.width - camera.width, me.x - camera.width / 2)
    );
    camera.y = Math.max(
      0,
      Math.min(world.height - camera.height, me.y - camera.height / 2)
    );
  }

  //get server response for firstime
  socket.on("server", (msg) => {
    console.log(msg);
  });

  //get server response for firstime
  socket.on("world", (data) => {
    world = data;
  });

  //get server response for firstime
  socket.on("camera", (data) => {
    camera = data;
  });

  //when data received from request
  socket.on("update", (data) => {
    players = data;
    latency = Math.ceil(performance.now() - startTime);
    updateCamera();
  });

  //request update data dan ping
  function requestServerUpdate() {
    startTime = performance.now();
    socket.emit("update", my_id);
  }

  //render ping to canvas
  function render_ping() {
    ctx.font = "16px monospace";
    ctx.fillStyle = "black";
    ctx.fillText(`id: ${my_id} speed: ${latency}ms`, 11, 50);
  }
  function drawWorld() {
    //hanya render tile yang didalam kamera yang dilooping dari map[][]
    const startX = Math.max(0, Math.floor(camera.x / tileSize.width));
    const startY = Math.max(0, Math.floor(camera.y / tileSize.height));
    const endX = Math.min(
      map[0].length,
      Math.ceil((camera.x + canvas.width) / tileSize.width)
    );
    const endY = Math.min(
      map.length,
      Math.ceil((camera.y + canvas.height) / tileSize.height)
    );

    for (let tileY = startY; tileY < endY; tileY++) {
      for (let tileX = startX; tileX < endX; tileX++) {
        const tile = {
          x: tileX * tileSize.width - camera.x,
          y: tileY * tileSize.height - camera.y,
          width: tileSize.width,
          height: tileSize.height,
        };

        // Ambil warna dari cache berdasarkan nilai tile
        const tileValue = map[tileY][tileX];
        ctx.fillStyle = tileColorCache[tileValue] || tileColorCache.default;

        // ambil tile yang sesuai dengan posisi mouse klik, bisa menggunakan map[tileX][tileY]
        if (mouse.isMouseClick && isRectCollide(tile, mouse)) {
          ctx.fillStyle = "#ff0000";
          console.log(`tile= ${tileX},${tileY}  clicked`);
        }

        ctx.fillRect(tile.x, tile.y, tile.width, tile.height);
      }
    }

    // Render mouse tile
    ctx.fillRect(mouse.x, mouse.y, mouse.width, mouse.height);
  }

  //render all players to canvas
  function render_players() {
    players.forEach((data) => {
      ctx.fillStyle = data.id == my_id ? "#22aaff" : "#ff22aa";
      ctx.fillRect(
        data.x - camera.x,
        data.y - camera.y,
        data.width,
        data.height
      );
      ctx.fillStyle = "#000000";
      ctx.fillText(
        data.id == my_id ? "you" : "id:" + data.id,
        data.x - camera.x,
        data.y - 5 - camera.y
      );
    });
  }

  function isRectCollide(target1, target2) {
    return (
      target1.x < target2.x + target2.width && // Kanan target1 tidak melewati kiri target2
      target1.x + target1.width > target2.x && // Kiri target1 tidak melewati kanan target2
      target1.y < target2.y + target2.height && // Bawah target1 tidak melewati atas target2
      target1.y + target1.height > target2.y // Atas target1 tidak melewati bawah target2
    );
  }

  //canvas render
  function update() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawWorld();
    render_ping();
    render_players();
    requestAnimationFrame(update);
  }

  requestAnimationFrame(update);
  setInterval(requestServerUpdate, 20);
</script>
